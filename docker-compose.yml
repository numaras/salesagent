# AdCP Sales Agent - Docker Compose for Development
#
# For local development with hot-reload.
#
# Usage:
#   docker compose up
#
# Endpoints (default port 3000):
#   http://localhost:3000/       - Admin UI (login here)
#   http://localhost:3000/mcp    - MCP Server (for AI agents)
#   http://localhost:8000/a2a    - A2A Server (agent-to-agent)
#
# First-time setup:
#   1. Log in with test credentials (admin@example.com / test123)
#   2. Configure SSO in Users & Access
#   3. Disable Setup Mode once SSO is working
#
# Environment variables (optional, via .env file):
#   TS_APP_PORT: Port for TypeScript app (default: 3000); ts-app service runs a minimal HTTP server

services:
  postgres:
    image: postgres:17-alpine
    environment:
      POSTGRES_DB: adcp
      POSTGRES_USER: adcp_user
      POSTGRES_PASSWORD: secure_password_change_me
    volumes:
      - adcp_postgres_data:/var/lib/postgresql/data
    # No host port exposure - access via docker compose exec if needed
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U adcp_user -d adcp"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Run TypeScript DB migrations once (creates tables). No Postgres install needed on host.
  ts-db-init:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql://adcp_user:secure_password_change_me@postgres:5432/adcp?sslmode=disable
    command: ["npm", "run", "db:migrate"]
    depends_on:
      postgres:
        condition: service_healthy
    restart: "no"

  # TypeScript app (MCP, A2A, Admin, health). Use DATABASE_URL to point at postgres.
  ts-app:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      PORT: "3000"
      DATABASE_URL: postgresql://adcp_user:secure_password_change_me@postgres:5432/adcp?sslmode=disable
    ports:
      - "${TS_APP_PORT:-3000}:3000"
    depends_on:
      postgres:
        condition: service_healthy
      ts-db-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', r => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 5s
      retries: 3

volumes:
  adcp_postgres_data:
